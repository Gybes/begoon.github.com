<!DOCTYPE html>
 
<html>
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>One-command NORCPU program hacking challenge: analysis and solutions</title>
   <link href="/favicon.png" rel="icon" />
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3017739-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" type="text/css" href="/css/highlight.css" />
   <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" />
   <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" /> 
   <link rel="alternate" title="Programming DIY" href="/english/atom.xml" type="application/atom+xml">
</head>
<body>

<div class="site">

  <div class="menu">
    <a class="extra" href="/">&laquo; по-русски &raquo;</a>  
    <a href="/english">blog</a> |
    <a href="/english/projects/">projects</a> |
    <a href="/english/articles/">articles</a> |
    <a href="/english/about/">about</a>
  </div>

  <div id="home">
    <h1>One-command NORCPU program hacking challenge: analysis and solutions</h1>
<div id="post">
  <p>Publishing the <a href="/blog/english/2011/02/08/norcpu-hackme-challenge/">announcement of the problem to hack</a> a program running on the CPU executing just one single command, I hoped to get a solution to the end of March, not earlier.</p>

<p>Note: Quoted materials below are provided &ldquo;as is&rdquo; in the original author edition. Only minor formatting changes are applied. Of course, the texts on Russian are translated to English.</p>

<p>But the reality was different. Literally a few hours after the announcement, I received an e-mail from <strong>Vasiliy Artemev</strong>.</p>

<blockquote>
<p>Secret code: 139471</p>
</blockquote>

<p>That was the correct answer. Vasiliy was a winner and received the 100$ prize. He kindly shared that he bruteforced the problem. In fact, a simple bruteforce attach forced the program printing out the magic message even on a 3-character attempt. Alas, my hash function used to check the password had many collisions and become a weak link.</p>

<p>But there was no complete analysis of the password checking algorithm, and Vasiliy offered to sponsor the rest of the challenge to figure out the algorithm with 50$ from his prize. The challenge kept going.</p>

<p>In meanwhile I wrote the <a href="/projects/norcpu/challenge/norcpu2.html">second version of the problem</a> without hashing but just an encrypted password. I hoped this makes the analysis harder. But in the same day evening I received an e-mail from <strong>Anton Bukov</strong>:</p>

<blockquote>
<p>Answer for NORCPU hackme challenge, Version 2: &ldquo;R0und2 D0ne!&rdquo; ?</p>
</blockquote>

<p>It was the correct one. I wondered how is it possible to figure out so quickly?</p>

<p>Anton also shared his approach.</p>

<blockquote>
<p>My hack is based on the line:</p>
</blockquote>

<pre><code>mem = mem_0.slice(0);
</code></pre>

<blockquote>
<p>An array gets copied here, and if you call <code>calc()</code> function twice on the same array, then for any incorrect password it will print out the answer. In code it looked as:</p>
</blockquote>

<pre><code>wcout &lt;&lt; calc(L&quot;0&quot;) &lt;&lt; endl &lt;&lt; calc(L&quot;0&quot;) &lt;&lt; endl;
</code></pre>

<blockquote>
<p>I guess that copying was used to prevent it. I&rsquo;m afraid this is not the way you expected. Even I was surprised when got the answer in the output. Afterwards I figured out where it appeared from.</p>
</blockquote>

<p>Accidentally Anton discovered a bug causing the program itself to reveal the secret, again. It needed just to run the interpreter twice without resetting memory.</p>

<p>The root of the problem:</p>

<div class="highlight"><pre><span class="nf">...</span>
  <span class="nf">IS_0</span><span class="p">(</span><span class="nv">flag</span><span class="p">)</span>
  <span class="nf">JZ</span> <span class="nv">okay</span>
  <span class="nf">EXIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nl">okay:</span>
  <span class="c1">; print the secret</span>
  <span class="nf">...</span>
</pre></div>

<p>After the first wrong run and refusing to print out the secret the program has stopped at the line 4, the <code>ip</code> register points to the <code>okay</code> label. If the interpreter gets started again without resetting memory (all registers including <code>ip</code> reside in memory), it keeps executing right from the <code>okay</code> and prints out the secret.</p>

<p>It was a shame. I fixed the problem quickly and released the version 2.1 without this side effect.</p>

<p>A couple of days left.</p>

<p>I received an e-mail from a guy with <strong>a5b</strong> nickname.</p>

<blockquote>
<p>Hot-patch of branching and the answer pw: <code>abcd</code> resp: <code>R0und2 D0ne!</code></p>

<ul>
<li>the password, obviously, is incorrect</li>
<li>inverted data being written to <code>(i == 27692 i==31712)</code></li>
</ul>
</blockquote>

<p>Formally, this is the solution, but there is no password which means the algorithm is not analysed so far.</p>

<p>But after an hour I received an addendum:</p>

<pre><code>h1cKmE1fUsAn

input data:
chr conI LEET xor
CHR1 13417 13313 104 h
CHR2 39953 39968 49 1
CHR3 54302 54397 99 c
CHR4 32223 32148 75 K
CHR5 30900 30937 109 m
CHR6 27373 27304 69 E
CHR7 16420 16405 49 1
CHR8 49210 49244 102 f
CHR9 16740 16689 85 U
CHR10 50115 50096 115 s
CHR11 19308 19245 65 A
CHR12 57802 57764 110 n

static init:
CHRi 59609= 59651
CONi 59610= 59634
CNTR 59611=12
SUM 59608=0
LEET 59607 = 13313

1:
[59609]+1 -&gt; [59609] // select next chr
[59610]+1 -&gt; [59610] // select next con

SUM |= CHRi ^ LEET ^ CONi
LEET = LEET * 3 + 29

[59611]: if([59611] != 0) Loop 1

...
if(SUM != 0) exit
else print R0und2 D0ne // haven't analysed this part.
// Based on the code modifications (moving the index), it loads 12 constants:
// 29528 22899 2971 9089 27542 17353 52278 25635 11626 34909 39131 51838,
// deals with each one and prints out.
</code></pre>

<p>This is the solution now. <strong>a5b</strong> became the first one who sent the algorithm of the <a href="/projects/norcpu/challenge/norcpu2.html">problem 2</a>.</p>

<p>In the same evening I received a solution from <strong>Max Filippov</strong>.</p>

<blockquote>
<p>Algorithm that was used to check password correctness in the first round was the following:</p>
</blockquote>

<div class="highlight"><pre><span class="kt">bool</span> <span class="n">check</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mh">0x1040</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="n">v</span> <span class="o">^=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
       <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
       <span class="p">{</span>
           <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
               <span class="n">v</span> <span class="o">^=</span> <span class="mh">0x1408</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">v</span> <span class="o">==</span> <span class="mh">0x1c89</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<blockquote>
<p>that is, sort of CRC.</p>

<p>To discover it I&rsquo;ve collected NORCPU execution trace and &ldquo;disassembled&rdquo; it.</p>

<p>Modified NORCPU source and disassembler are attached, and also may be found <a href="http://jcmvbkbc.spb.ru/git/?p=dumb/norcpu.git;a=summary">there</a>.</p>
</blockquote>

<p>And a little add-on:</p>

<blockquote>
<p>The method used is pretty straightforward:</p>

<ul>
<li>collect execution trace;</li>
<li>recognize instruction patterns and collapse sequences of primitive instructions to more complex ones;</li>
<li>analyze disassembled trace.</li>
</ul>

<p>So, first I needed trace: I copied javascript text into cpp source, fixed lingual differences and inserted the following printf:</p>
</blockquote>

<div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">];</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%04x:NOR(%04x, %04x =&gt; %04x) &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
</pre></div>

<blockquote>
<p>so that I got a long line (about 8Mb) of primitive instruction execution trace.</p>

<p>Then I started constructing sed script that would make it readable.</p>

<p>First, it broke the trace linewise, one instruction per line (288323 lines, will read it in case of insomnia). I took a look at processed trace and recorded several obvious instruction patterns into sed. Then reran script, took next look, recorded more patterns, &hellip;</p>

<p>This way I figured out all boolean logic commands and jumps. Then rotations left. Each time new command got recognized, new filtered processed trace was suggesting next step, e.g. 15 ROTL equals ROTR etc.</p>

<p>Then I looked into <a href="/blog/english/2010/04/06/modelling-a-cpu-with-only-one-operation/">your article</a>. And found addition pattern in disassembly. And recorded it in sed script.</p>

<p>After that I was able to just read the trace (which shrink to 1035 lines). Its inner loop fit into one page, I just made some notes on a scratchpad:</p>
</blockquote>

<pre><code>[f1ba]: current in-T index (i)
[f1b4]: LEN
[f1b5]: 8

0012-0035:[f1b9] ^= (T[i] &amp; 0xff)

006d-007b:[f1b8] = [f1b9] &amp; 1
008a-0158:[f1b9] &gt;&gt;= 1
0167-10c7:[f1aa] = [f1b8] + -1, [f1ab] = !carry
10ca-10e6:jmp on carry to 1145:110d

110d-111b:[f1b9] ^= 1408

1145-1f4f:--[f1b5]
20a5-3005:[f1aa] = [f1b5] + -1, f1ab = !carry
3008-3024:jmp on carry to 006d:304b

304b-304b:++i
3fab-3fab:--LEN
4f0b-5e8a:jmp on carry to 5eb1:6
</code></pre>

<blockquote>
<p>then I browsed through the repetitions of this inner loop and found the end of the outer loop.</p>
</blockquote>

<pre><code>5eb1-6e74:check 1c89
</code></pre>

<blockquote>
<p>Then just translated it into C. It all took me three evenings.</p>
</blockquote>

<p>Then Max Filippov sent the solution for the <a href="/projects/norcpu/challenge/norcpu2.html">problem 2</a>.</p>

<blockquote>
<p>The second problem answer &ndash; <code>h1cKmE1fUsAn</code></p>

<p>The result &ndash; <code>R0und2 D0ne!</code></p>

<p>The password check algorithm is:</p>
</blockquote>

<div class="highlight"><pre><span class="kt">bool</span> <span class="n">check</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
   <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">xor_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
       <span class="mh">0x3469</span><span class="p">,</span>
       <span class="mh">0x9c11</span><span class="p">,</span>
       <span class="mh">0xd41e</span><span class="p">,</span>
       <span class="mh">0x7ddf</span><span class="p">,</span>
       <span class="mh">0x78b4</span><span class="p">,</span>
       <span class="mh">0x6aed</span><span class="p">,</span>
       <span class="mh">0x4024</span><span class="p">,</span>
       <span class="mh">0xc03a</span><span class="p">,</span>
       <span class="mh">0x4164</span><span class="p">,</span>
       <span class="mh">0xc3c3</span><span class="p">,</span>
       <span class="mh">0x4b6c</span><span class="p">,</span>
       <span class="mh">0xe1ca</span><span class="p">,</span>
   <span class="p">};</span>

   <span class="kt">int</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mh">0x3401</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">x</span> <span class="o">^</span> <span class="n">xor_array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
       <span class="c1">// printf(&quot;x: %04x, f: %04x\n&quot;, x, f);</span>
       <span class="n">v</span> <span class="o">|=</span> <span class="n">f</span><span class="p">;</span>
       <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mh">0x1d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="o">!</span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<blockquote>
<p>The commented printf prints out the secret phrase on-the-fly.</p>

<p>The method of analysis &ndash; similar to the first problem &ndash; disassembling of the trace.</p>

<p>The first round was frankly more interestintg.</p>
</blockquote>

<p>And, finally, the last solution of the <a href="/projects/norcpu/challenge/norcpu.html">first problem</a> is received from <strong>Salo Kril</strong>.</p>

<p>No comments &ndash; just sources.</p>

<div class="highlight"><pre><span class="c1">// Password generation.</span>

<span class="c1">// Brute_force(3);</span>

<span class="n">WORD</span> <span class="n">ks_f</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
   <span class="n">WORD</span> <span class="n">ks</span> <span class="o">=</span> <span class="mh">0x1040</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="n">ks</span> <span class="o">^=</span> <span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
       <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
       <span class="p">{</span>
           <span class="k">if</span><span class="p">((</span><span class="n">ks</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
               <span class="n">ks</span> <span class="o">=</span> <span class="n">ks</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
           <span class="k">else</span>
               <span class="n">ks</span> <span class="o">=</span> <span class="p">(</span><span class="n">ks</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1408</span><span class="p">;</span>
       <span class="p">}</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">ks</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Brute_force</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="k">static</span> <span class="kt">char</span> <span class="n">alphabet</span><span class="p">[]</span> <span class="o">=</span>
       <span class="s">&quot;</span><span class="se">\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F</span><span class="s">&quot;</span>
       <span class="s">&quot;</span><span class="se">\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x3E\x3F</span><span class="s">&quot;</span>
       <span class="s">&quot;</span><span class="se">\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4A\x4B\x4C\x4D\x4E\x4F</span><span class="s">&quot;</span>
       <span class="s">&quot;</span><span class="se">\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5A\x5B\x5C\x5D\x5E\x5F</span><span class="s">&quot;</span>
       <span class="s">&quot;</span><span class="se">\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6A\x6B\x6C\x6D\x6E\x6F</span><span class="s">&quot;</span>
       <span class="s">&quot;</span><span class="se">\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7A\x7B\x7C\x7D\x7E</span><span class="s">&quot;</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">if</span><span class="p">(</span><span class="n">ks_f</span><span class="p">(</span><span class="n">buff_bf</span><span class="p">,</span> <span class="n">BF_N</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1c89</span><span class="p">)</span>
           <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buff_bf</span><span class="p">);</span>
       <span class="k">return</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">n</span><span class="o">--</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="n">buff_bf</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
       <span class="n">Brute_force</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>and re-constructed code:</p>

<div class="highlight"><pre><span class="cp">#define DEST_COUNT  0xF1FE</span>
<span class="k">extern</span> <span class="n">WORD</span> <span class="n">mem</span><span class="p">[];</span>

<span class="cm">/*</span>
<span class="cm">    Secret code: 139471</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="n">reconstructed_fn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">hash_OK</span><span class="p">,</span> <span class="n">key_const</span><span class="p">;</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BA</span><span class="p">];</span>     <span class="c1">// input string</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1ED</span><span class="p">];</span>   <span class="c1">// input string length</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BB</span><span class="p">];</span>    <span class="c1">// 0xf1ff</span>
    <span class="n">hash_OK</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BC</span><span class="p">];</span> <span class="c1">// 0x1c89</span>
    <span class="n">hash</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1B9</span><span class="p">];</span>    <span class="c1">// 0x1040</span>


    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">hash</span> <span class="o">^=</span> <span class="n">mem</span><span class="p">[</span><span class="n">src</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">hash</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1408</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">==</span> <span class="n">hash_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x6EB6</span><span class="p">];</span>              <span class="c1">// &quot;Secret code: 139471&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1C7</span><span class="p">];</span>            <span class="c1">// 19</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">((</span><span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">hash</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">key_const</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x6EA8</span><span class="p">];</span>        <span class="c1">// 11</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x5EBE</span><span class="p">];</span>          <span class="c1">// &quot;Wrong password!&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1DC</span><span class="p">];</span>        <span class="c1">// 15</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BD</span><span class="p">];</span>
        <span class="n">key_const</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BE</span><span class="p">];</span>    <span class="c1">// 17</span>
    <span class="p">}</span>

    <span class="n">mem</span><span class="p">[</span><span class="n">DEST_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">mem</span><span class="p">[</span><span class="n">dest</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">src</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">key</span><span class="p">;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">key_const</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">--------------------------------------------------------------------------------------------</span>
<span class="cm">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="cm">--------------------------------------------------------------------------------------------</span>
<span class="cm">*/</span>
<span class="n">WORD</span> <span class="n">and</span><span class="p">(</span><span class="n">WORD</span> <span class="n">w1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">w1</span> <span class="o">&amp;</span> <span class="n">w2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">WORD</span> <span class="n">or</span><span class="p">(</span><span class="n">WORD</span> <span class="n">w1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">w1</span> <span class="o">|</span> <span class="n">w2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">WORD</span> <span class="n">xor</span><span class="p">(</span><span class="n">WORD</span> <span class="n">w1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">w2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">w1</span> <span class="o">^</span> <span class="n">w2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">WORD</span> <span class="n">rol</span><span class="p">(</span><span class="n">WORD</span> <span class="n">w1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">WORD</span> <span class="n">ror</span><span class="p">(</span><span class="n">WORD</span> <span class="n">w1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">w1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">n</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">WORD</span> <span class="n">extend_16</span><span class="p">(</span><span class="n">WORD</span> <span class="n">k1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k2</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">or</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span> <span class="n">k1</span><span class="p">);</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">k2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">WORD</span> <span class="n">add</span><span class="p">(</span><span class="n">WORD</span> <span class="o">*</span><span class="n">kk1</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">a</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WORD</span> <span class="n">mask_bit</span><span class="p">,</span> <span class="n">aa0</span><span class="p">,</span> <span class="n">aa1</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">;</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">mask_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">mask_bit</span><span class="p">);</span>
        <span class="n">aa0</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">aa0</span><span class="p">,</span> <span class="n">k1</span><span class="p">);</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">mask_bit</span><span class="p">);</span>
        <span class="n">k2</span> <span class="o">=</span> <span class="n">or</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,</span> <span class="n">k2</span><span class="p">);</span>
        <span class="n">aa1</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
        <span class="n">aa0</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">aa0</span><span class="p">);</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">or</span><span class="p">(</span><span class="n">aa1</span><span class="p">,</span> <span class="n">aa0</span><span class="p">);</span>
        <span class="n">k1</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">mask_bit</span> <span class="o">=</span> <span class="n">rol</span><span class="p">(</span><span class="n">mask_bit</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">k1</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span> <span class="n">mask_bit</span><span class="p">);</span>
    <span class="o">*</span><span class="n">kk1</span> <span class="o">=</span> <span class="n">extend_16</span><span class="p">(</span><span class="n">k1</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">k2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">reconstr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WORD</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ks</span><span class="p">,</span> <span class="n">ks_OK</span><span class="p">,</span> <span class="n">key_a</span><span class="p">;</span>
    <span class="n">WORD</span> <span class="n">mask_bit</span><span class="p">,</span> <span class="n">aa1</span><span class="p">,</span> <span class="n">aa0</span><span class="p">;</span>

    <span class="n">k1</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1AF</span><span class="p">];</span>    <span class="c1">// 0x88</span>
    <span class="n">k2</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1A3</span><span class="p">];</span>    <span class="c1">// 0x47</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BA</span><span class="p">];</span>   <span class="c1">// input string</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1ED</span><span class="p">];</span> <span class="c1">// input string length</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BB</span><span class="p">];</span>  <span class="c1">// 0xf1ff</span>
    <span class="n">ks_OK</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BC</span><span class="p">];</span> <span class="c1">// 0x1c89             &quot;w&quot;:ks=0x0ACC   &quot;WWW&quot;:0x0FCE   &quot;123456789&quot;:ks=0x05E3</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1B9</span><span class="p">];</span>    <span class="c1">// 0x1040</span>


<span class="nl">l_0006:</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">and</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="mh">0xFF</span><span class="p">));</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

<span class="nl">l_006D:</span>
    <span class="n">tmp3</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">ror</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mh">0x1408</span><span class="p">);</span>
    <span class="p">}</span>

<span class="nl">l_1145:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">l_006D</span><span class="p">;</span>

<span class="nl">l_304B:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k2</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">l_0006</span><span class="p">;</span>


    <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x5EBE</span><span class="p">];</span>    <span class="c1">// Wrong password!</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1DC</span><span class="p">];</span>  <span class="c1">// 15</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BD</span><span class="p">];</span>
    <span class="n">key_a</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1BE</span><span class="p">];</span>
    <span class="n">ks_OK</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">ks_OK</span><span class="p">,</span> <span class="n">ks</span><span class="p">);</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k2</span><span class="p">,</span> <span class="n">ks_OK</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">k2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">l_8552</span><span class="p">;</span>

<span class="nl">l_6E9B:</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x6EB6</span><span class="p">];</span>     <span class="c1">// Secret code: 139471</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1C7</span><span class="p">];</span>   <span class="c1">// 19</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">ks</span><span class="p">;</span>
    <span class="n">key_a</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0x6EA8</span><span class="p">];</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">ror</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">and</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>


<span class="nl">l_8552:</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">DEST_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">l_8558:</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">xor</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">src</span><span class="p">],</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">tmp3</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">);</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_a</span><span class="p">);</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">dest</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k1</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k2</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">k2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">l_8558</span><span class="p">;</span>

<span class="nl">l_F186:</span>
    <span class="n">mem</span><span class="p">[</span><span class="mh">0xF1B2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="mh">0xF193</span><span class="p">];</span> <span class="c1">// nc</span>
<span class="p">}</span>
</pre></div>

<p>Well, as you understand the solutions have been fully comprehensive.</p>

<p>Thanks to all participants.</p>

<p>I&rsquo;m putting the original sources below. Just run the Python script to compile the code written on the function-macros, to run through and to generate an html-page (&ldquo;template.html&rdquo; is required).</p>

<p>All the sources are available on as a git <a href="https://github.com/begoon/norcpu/">repository</a>.</p>

<h2>Problem 1</h2>

<p>File <a href="https://github.com/begoon/norcpu/blob/master/v1/norcpu.py">norcpu.py</a> (<a href="https://github.com/begoon/norcpu/blob/master/v1/template.html">template.html</a>):</p>

<div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">binascii</span>

<span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">verbose_cpu</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">scramble</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">test_wrong_crc</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">secret_code</span> <span class="o">=</span> <span class="s">&quot;Secret code: 139471&quot;</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">&quot;h0cKmE1fUsAn&quot;</span>
<span class="n">guess</span>    <span class="o">=</span> <span class="s">&quot;123456789012&quot;</span>
<span class="n">guess</span>    <span class="o">=</span> <span class="n">password</span>

<span class="c"># Secret code message encryption mask.</span>
<span class="n">secret_coef_add</span> <span class="o">=</span> <span class="mi">17</span>

<span class="n">message_text</span> <span class="o">=</span> <span class="s">&quot;Wrong password!&quot;</span>
<span class="c"># Wrong password message encryption mask.</span>
<span class="n">message_mask</span> <span class="o">=</span> <span class="mh">0x6301</span>
<span class="n">message_coef_add</span> <span class="o">=</span> <span class="mi">11</span>

<span class="c"># Non-standard CRC initial value (should be 0xFFFF).</span>
<span class="n">crc16_initial_value</span> <span class="o">=</span> <span class="mh">0x1040</span>

<span class="c"># Non-standard CRC constant (should be 0x8401).</span>
<span class="n">crc16_constant</span> <span class="o">=</span> <span class="mh">0x1408</span>

<span class="n">code_segment</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data_segment</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">label_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
    <span class="n">hex_line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%04X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%04X</span><span class="s">: </span><span class="si">%-*s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">hex_line</span><span class="p">))</span>
  <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">dump_js</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
    <span class="n">hex_line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;0x</span><span class="si">%04X</span><span class="s">,&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">])</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%-*s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">hex_line</span><span class="p">))</span>
  <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calc_crc16</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">crc16_initial_value</span>
  <span class="k">global</span> <span class="n">crc16_constant</span>

  <span class="n">crc16</span> <span class="o">=</span> <span class="n">crc16_initial_value</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
    <span class="n">crc16</span> <span class="o">=</span> <span class="n">crc16</span> <span class="o">^</span> <span class="n">ch</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">crc16</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">crc16</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc16</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">crc16_constant</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">crc16</span> <span class="o">=</span> <span class="n">crc16</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="n">crc16</span>

<span class="n">crc16</span> <span class="o">=</span> <span class="n">calc_crc16</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">encode_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">coef_add</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">mem</span><span class="p">,</span> <span class="n">names</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">offset_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_sz&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">coef_add</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
  <span class="n">mem</span><span class="p">[</span><span class="n">offset_sz</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">put_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
  <span class="k">global</span> <span class="n">mem</span><span class="p">,</span> <span class="n">names</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">offset_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_sz&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
  <span class="n">mem</span><span class="p">[</span><span class="n">offset_sz</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_mem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size</span><span class="p">]):</span>
    <span class="nb">hex</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%04X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="nb">bin</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="nb">hex</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
  <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">next_label</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">label_count</span>
  <span class="n">label_count</span> <span class="o">=</span> <span class="n">label_count</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="s">&quot;label_</span><span class="si">%04d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">label_count</span>

<span class="k">def</span> <span class="nf">code_rem</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
  <span class="n">code_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; &#39;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">data_rem</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
  <span class="n">data_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; &#39;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">data_label</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="n">data_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">code_label</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="n">code_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">code</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="n">printed</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;int&#39;</span><span class="p">:</span>
    <span class="n">printed</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span>
  <span class="n">code_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  dw </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">printed</span><span class="p">)</span>

<span class="n">scramble_counter</span> <span class="o">=</span> <span class="mh">0x27</span>

<span class="k">def</span> <span class="nf">next_scramble_counter</span><span class="p">():</span>
  <span class="k">global</span> <span class="n">scramble_counter</span>
  <span class="n">scramble_counter</span> <span class="o">=</span> <span class="n">scramble_counter</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">7</span>
  <span class="k">return</span> <span class="n">scramble_counter</span> <span class="o">&amp;</span> <span class="mh">0xff</span>

<span class="k">def</span> <span class="nf">word</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">scramble</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">next_scramble_counter</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">printed</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;int&#39;</span><span class="p">:</span>
    <span class="n">printed</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span>
  <span class="n">data_segment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  dw </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">printed</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">data_label</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

<span class="k">def</span> <span class="nf">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;NOR &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
  <span class="n">code</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

<span class="k">def</span> <span class="nf">OR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;or_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;or_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;or_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;and_reg_b&quot;</span><span class="p">)</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;and_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_reg_b&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ANDi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;and_i_reg&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;and_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_i_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;xor_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">XORi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;xor_i_reg&quot;</span><span class="p">)</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_i_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;MOV &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;move_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;MOV END&#39;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">JMP</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;JMP &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">JMPi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;JMPi &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">JMP</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;MOVi #&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">label_data</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">label_jump</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">label_data</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">JMPi</span><span class="p">(</span><span class="n">label_jump</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label_jump</span><span class="p">)</span>

<span class="c"># [a] -&gt; b</span>
<span class="k">def</span> <span class="nf">PEEK</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">label1</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">label2</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label2</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>  <span class="c"># NOT(0, 0, move_reg)</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="c"># &lt;- a</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label2</span><span class="p">)</span>  <span class="c">#</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="c"># &lt;- a</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="c">#</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c"># a -&gt; [b]</span>
<span class="k">def</span> <span class="nf">POKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="s">&#39;POKE &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; [&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;]&#39;</span><span class="p">)</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;move_reg&quot;</span><span class="p">)</span>  <span class="c"># +3 (three operations)</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="c"># +4</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="c"># +5</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="c"># &lt;- b</span>

<span class="c"># imm -&gt; [a]</span>
<span class="k">def</span> <span class="nf">POKEi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;poke_i_reg&quot;</span><span class="p">)</span>
  <span class="n">POKE</span><span class="p">(</span><span class="s">&quot;poke_i_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;poke_i_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">EXIT</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">EXITi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">FADD</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_a&quot;</span><span class="p">)</span>  <span class="c"># zero bits in &#39;a&#39; except mask&#39;ed</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_b&quot;</span><span class="p">)</span>  <span class="c"># zero bits in &#39;b&#39; except mask&#39;ed</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>     <span class="c"># zero bits in &#39;carry&#39; except mask&#39;ed</span>

  <span class="c"># SUM = (a ^ b) ^ carry</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>
  <span class="n">XOR</span><span class="p">(</span><span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">,</span> <span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>

  <span class="c"># Leave only &#39;mask&#39;ed bit in bit_r.</span>
  <span class="n">AND</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>

  <span class="c"># Add current added bit to the result.</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

  <span class="c"># CARRY = (a &amp; b) | (carry &amp; (a ^ b))</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>

  <span class="c"># CARRY is calculated, and &#39;shift_reg&#39; contains the same value</span>
  <span class="c"># but shifted the left by 1 bit.</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

  <span class="c"># CARRY is shifted the left by 1 bit to be used on the next round.</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

  <span class="c"># shift_reg = mask &lt;&lt; 1</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
  <span class="c"># mask = shift (effectively &quot;mask = mask &lt;&lt; 1&quot;)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_b&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ZERO</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
    <span class="n">FADD</span><span class="p">(</span><span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
    <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
    <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
    <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>

  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
  <span class="n">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ADDi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;add_i_reg&quot;</span><span class="p">)</span>
  <span class="n">ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;add_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;add_i_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">PUSH</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">ADD</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>
  <span class="n">POKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">PUSHi</span><span class="p">(</span><span class="n">imm</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>
  <span class="n">PUSH</span><span class="p">(</span><span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">POP</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">ADD</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">CALL</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">PUSHi</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">JMP</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">CALLi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">PUSHi</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">JMPi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">RET</span><span class="p">():</span>
  <span class="n">POP</span><span class="p">(</span><span class="s">&quot;ip&quot;</span><span class="p">)</span>

<span class="c"># Jump &#39;a&#39;, if cond = FFFF, and &#39;b&#39; if conf = 0000</span>
<span class="k">def</span> <span class="nf">BRANCH</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="s">&quot;branch_reg_a&quot;</span><span class="p">)</span>              <span class="c"># reg_a = a &amp; cond</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>                 <span class="c"># reg_b = !cond</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>    <span class="c"># reg_b = b &amp; reg_b = b &amp; !cond</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;branch_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">)</span>  <span class="c"># ip = (a &amp; cond) | (b &amp; !cond)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>

<span class="c"># Jump &#39;a&#39;, if cond = FFFF, and &#39;b&#39; if conf = 0000</span>
<span class="k">def</span> <span class="nf">BRANCHi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cond</span><span class="p">):</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">)</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">)</span>
  <span class="n">BRANCH</span><span class="p">(</span><span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">)</span>

<span class="c"># if a != 0 -&gt; carry = FFFF else carry = 0000</span>
<span class="k">def</span> <span class="nf">IS_0</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
  <span class="n">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;is_0_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;is_0_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>

<span class="c"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="k">def</span> <span class="nf">JZi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">BRANCHi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="c"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="k">def</span> <span class="nf">JNZi</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">BRANCHi</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ROL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>            <span class="c"># shift_reg = a &lt;&lt; 1</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ROR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">):</span>
    <span class="n">ROL</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">,</span> <span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">SHL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">ROL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">ANDi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">SHR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">ROR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">ANDi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="c"># NORCPU code</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ip&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;stack&quot;</span><span class="p">)</span>

<span class="n">code_label</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;j&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="n">crc16_initial_value</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">)</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;password_sz&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>

<span class="n">crc_loop</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">crc_loop</span><span class="p">)</span>          <span class="c"># crc_loop</span>
<span class="c"># ch = *ptr</span>
<span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="c"># ch &amp;= 0xFF</span>
<span class="n">ANDi</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="c"># crc16 ^= ch</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;crc16&quot;</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;j&quot;</span><span class="p">)</span>
<span class="n">crc_loop_j</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">crc_loop_j</span><span class="p">)</span>        <span class="c"># crc_loop_j</span>

<span class="c"># t = crc16 &amp; 1</span>
<span class="n">ANDi</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">)</span>
<span class="c"># crc16 &gt;&gt;= 1</span>
<span class="n">SHR</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="s">&quot;crc16&quot;</span><span class="p">)</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">)</span>
<span class="n">crc_loop_1</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">JZi</span><span class="p">(</span><span class="n">crc_loop_1</span><span class="p">)</span>
<span class="c"># crc16 ^= crc16_constant</span>
<span class="n">XORi</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="n">crc16_constant</span><span class="p">,</span> <span class="s">&quot;crc16&quot;</span><span class="p">)</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">crc_loop_1</span><span class="p">)</span>        <span class="c"># crc_loop_1</span>

<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;j&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;j&quot;</span><span class="p">)</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;j&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">crc_loop_j</span><span class="p">)</span>

<span class="c"># ptr += 1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="c"># i = i - 1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">crc_loop</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">,</span> <span class="s">&quot;result&quot;</span><span class="p">)</span>

<span class="n">correct_crc</span> <span class="o">=</span> <span class="n">crc16</span> <span class="o">+</span> <span class="n">test_wrong_crc</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;correct_crc&quot;</span><span class="p">,</span> <span class="n">correct_crc</span><span class="p">)</span>

<span class="c"># By default we&#39;re going to decrypt &#39;Wrong...&#39; message.</span>
<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;message_sz&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;message_mask&quot;</span><span class="p">,</span> <span class="n">message_mask</span><span class="p">)</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;message_mask&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;coef_add&quot;</span><span class="p">,</span> <span class="n">message_coef_add</span><span class="p">)</span>

<span class="n">wrong_label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>

<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;correct_crc&quot;</span><span class="p">,</span> <span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="s">&quot;correct_crc&quot;</span><span class="p">)</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;correct_crc&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">wrong_label</span><span class="p">)</span>

<span class="c"># Now we switch to descrypt the secret message.</span>
<span class="n">MOVi</span><span class="p">(</span><span class="n">secret_coef_add</span><span class="p">,</span> <span class="s">&quot;coef_add&quot;</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;secret&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;secret_sz&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>

<span class="c"># mask = ((crc16 &amp; 0xff) | ((crc16 &gt;&gt; 8) &amp; 0xff)) + 1</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>
  <span class="n">SHR</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;crc16&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="n">ANDi</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>

<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>

<span class="n">code_label</span><span class="p">(</span><span class="n">wrong_label</span><span class="p">)</span>

<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;result_sz&quot;</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>              <span class="c"># loop</span>
<span class="c"># ch = *ptr</span>
<span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="c"># ch ^= mask</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="n">POKE</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>
<span class="c"># mask = mask * 3 + 11</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">)</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="s">&quot;coef_add&quot;</span><span class="p">,</span> <span class="s">&quot;mask&quot;</span><span class="p">)</span>
<span class="c"># ptr += 1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="c"># ptr2 += 1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>
<span class="c"># i = i - 1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

<span class="n">EXITi</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>

<span class="nb">buffer</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;stack&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;secret_sz&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">secret_code</span><span class="p">))</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;secret&quot;</span><span class="p">)</span>
<span class="nb">buffer</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secret_code</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;message_sz&quot;</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">)</span>
<span class="nb">buffer</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;password_sz&quot;</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;password&quot;</span><span class="p">)</span>
<span class="nb">buffer</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="c"># The buffer holding the result string.</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;result_sz&quot;</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;result&quot;</span><span class="p">)</span>
<span class="nb">buffer</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="c"># Compiler</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">code_segment</span>
<span class="n">text</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data_segment</span><span class="p">)</span>

<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="c"># Phase 1. Calculate names.</span>

<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span> <span class="k">continue</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
  <span class="k">print</span> <span class="n">names</span>

<span class="n">raw_text</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="c"># Resolve names.</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
  <span class="n">name_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;dw &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">raw_text</span> <span class="o">=</span> <span class="n">name_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;dw &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">)</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">raw_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="c"># Phase 2. Compilation.</span>

<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="n">mem</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;</span><span class="si">%04X</span><span class="s">: </span><span class="si">%04X</span><span class="s"> ; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="n">mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="c"># Interpretation</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">]</span>
<span class="n">exit_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exit_reg&quot;</span><span class="p">]</span>
<span class="n">shift_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;shift_reg&quot;</span><span class="p">]</span>
<span class="n">carry_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;carry_reg&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">nor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|</span> <span class="n">b</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">^</span> <span class="mh">0xFFFF</span>
  <span class="k">return</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>

<span class="k">def</span> <span class="nf">norcpu</span><span class="p">():</span>
  <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">];</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nor</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">shift_reg</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose_cpu</span><span class="p">:</span>
      <span class="k">print</span> <span class="s">&quot;</span><span class="si">%04X</span><span class="s">: </span><span class="si">%04X</span><span class="s"> [</span><span class="si">%04X</span><span class="s">] </span><span class="si">%04X</span><span class="s"> [</span><span class="si">%04X</span><span class="s">] -&gt; </span><span class="si">%04X</span><span class="s"> [</span><span class="si">%04X</span><span class="s">]&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">exit_reg</span><span class="p">:</span>
      <span class="k">break</span>

<span class="k">print</span> <span class="s">&quot;Starting from [</span><span class="si">%04X</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>

<span class="c"># Encrypt the secret code.</span>
<span class="n">secret_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">crc16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="n">crc16</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">encode_string</span><span class="p">(</span><span class="n">secret_code</span><span class="p">,</span> <span class="s">&quot;secret&quot;</span><span class="p">,</span> <span class="n">secret_mask</span><span class="p">,</span> <span class="n">secret_coef_add</span><span class="p">);</span>

<span class="c"># Encrypt &#39;Wrong...&#39; message.</span>
<span class="n">encode_string</span><span class="p">(</span><span class="n">message_text</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="n">message_mask</span><span class="p">,</span> <span class="n">message_coef_add</span><span class="p">);</span>

<span class="n">mem_js</span> <span class="o">=</span> <span class="n">dump_js</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-1-before.bin&quot;</span><span class="p">)</span>
<span class="n">mem_sz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;Too much code (</span><span class="si">%08X</span><span class="s">, </span><span class="si">%04X</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10000</span><span class="p">)</span>
  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="c"># Inject plain password in the last moment (for testing).</span>
<span class="n">put_string</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="s">&quot;password&quot;</span><span class="p">)</span>

<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-2-before-with-password.bin&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;Original memory:&quot;</span>
  <span class="k">print</span> <span class="n">dump</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">norcpu</span><span class="p">()</span>

<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-3-after.bin&quot;</span><span class="p">,</span> <span class="n">mem_sz</span><span class="p">)</span>

<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;Memory after:&quot;</span>
  <span class="n">dump</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="k">print</span>
<span class="k">print</span> <span class="s">&quot;Size: </span><span class="si">%X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Time: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Exit: </span><span class="si">%04X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mem</span><span class="p">[</span><span class="n">exit_reg</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;CRC : </span><span class="si">%04X</span><span class="s"> (</span><span class="si">%04X</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crc16</span><span class="p">,</span> <span class="n">correct_crc</span><span class="p">))</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;result&quot;</span><span class="p">]</span>
<span class="n">result_value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s">&quot;result_sz&quot;</span><span class="p">]]):</span>
  <span class="n">result_value</span> <span class="o">=</span> <span class="n">result_value</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">result</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

<span class="k">if</span> <span class="n">result_value</span> <span class="o">!=</span> <span class="n">secret_code</span><span class="p">:</span>
  <span class="k">print</span> <span class="s">&quot;ERROR: [</span><span class="si">%s</span><span class="s">] != [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secret_code</span><span class="p">,</span> <span class="n">result_value</span><span class="p">)</span>

<span class="n">js</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;template.html&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">js</span> <span class="o">=</span> <span class="n">js</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span> \
  <span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">],</span>
  <span class="n">exit_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exit_reg&quot;</span><span class="p">],</span>
  <span class="n">shift_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;shift_reg&quot;</span><span class="p">],</span>
  <span class="n">password</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;password&quot;</span><span class="p">],</span>
  <span class="n">password_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;password_sz&quot;</span><span class="p">],</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;result&quot;</span><span class="p">],</span>
  <span class="n">result_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;result_sz&quot;</span><span class="p">],</span>
  <span class="n">mem_js</span> <span class="o">=</span> <span class="n">mem_js</span>
<span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;norcpu.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

<h2>Problem 2</h2>

<p>File <a href="https://github.com/begoon/norcpu/blob/master/v2/norcpu.py">norcpu.py</a> (<a href="https://github.com/begoon/norcpu/blob/master/v2/template.html">template.html</a>):</p>

<div class="highlight"><pre><span class="n">import</span> <span class="n">sys</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">binascii</span>

<span class="n">verbose</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">verbose_cpu</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">scramble</span> <span class="o">=</span> <span class="n">True</span>

<span class="n">secret_password</span> <span class="o">=</span> <span class="s">&quot;h1cKmE1fUsAn&quot;</span>
<span class="n">secret_password_xor_mask</span> <span class="o">=</span> <span class="mh">0x3401</span>
<span class="n">secret_password_add</span> <span class="o">=</span> <span class="mi">29</span>

<span class="n">secret_code</span> <span class="o">=</span> <span class="s">&quot;R0und2 D0ne!&quot;</span>
<span class="n">secret_code_xor_mask</span> <span class="o">=</span> <span class="mh">0x730A</span>
<span class="n">secret_code_add</span> <span class="o">=</span> <span class="mi">37</span>

<span class="n">guess</span> <span class="o">=</span> <span class="s">&quot;123456789012&quot;</span>
<span class="n">guess</span> <span class="o">=</span> <span class="n">secret_password</span>

<span class="n">code_segment</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data_segment</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">label_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">def</span> <span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span><span class="o">:</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span><span class="o">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nl">i:</span><span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
    <span class="n">hex_line</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;%04X&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">line</span><span class="p">])</span>
    <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;%04X: %-*s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">hex_line</span><span class="p">))</span>
  <span class="k">return</span> <span class="err">&#39;&#39;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">def</span> <span class="n">dump_js</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">)</span><span class="o">:</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">length</span><span class="p">)</span><span class="o">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nl">i:</span><span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
    <span class="n">hex_line</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;0x%04X,&quot;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">line</span><span class="p">])</span>
    <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;%-*s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">hex_line</span><span class="p">))</span>
  <span class="k">return</span> <span class="err">&#39;&#39;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="n">def</span> <span class="n">encode_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">coef_add</span><span class="p">)</span><span class="o">:</span>
  <span class="n">global</span> <span class="n">mem</span><span class="p">,</span> <span class="n">names</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">offset_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_sz&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">:</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">^</span> <span class="n">mask</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">coef_add</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
  <span class="n">mem</span><span class="p">[</span><span class="n">offset_sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">def</span> <span class="n">put_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">:</span>
  <span class="n">global</span> <span class="n">mem</span><span class="p">,</span> <span class="n">names</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">offset_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_sz&quot;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">:</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ord</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
  <span class="n">mem</span><span class="p">[</span><span class="n">offset_sz</span><span class="p">]</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">def</span> <span class="n">save_mem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span> <span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="n">size</span><span class="p">])</span><span class="o">:</span>
    <span class="n">hex</span> <span class="o">=</span> <span class="s">&quot;%04X&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">bin</span> <span class="o">=</span> <span class="n">binascii</span><span class="p">.</span><span class="n">a2b_hex</span><span class="p">(</span><span class="n">hex</span><span class="p">)</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bin</span><span class="p">)</span>
  <span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">def</span> <span class="n">next_label</span><span class="p">()</span><span class="o">:</span>
  <span class="n">global</span> <span class="n">label_count</span>
  <span class="n">label_count</span> <span class="o">=</span> <span class="n">label_count</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="s">&quot;label_%04d&quot;</span> <span class="o">%</span> <span class="n">label_count</span>

<span class="n">def</span> <span class="n">code_rem</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="p">;</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>

<span class="n">def</span> <span class="n">data_rem</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span><span class="o">:</span>
  <span class="n">data_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="err">&#39;</span><span class="p">;</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">comment</span><span class="p">)</span>

<span class="n">def</span> <span class="n">data_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">:</span>
  <span class="n">data_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">code_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">code</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">:</span>
  <span class="n">printed</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">if</span> <span class="n">type</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="kt">int</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">printed</span> <span class="o">=</span> <span class="s">&quot;%d&quot;</span> <span class="o">%</span> <span class="n">value</span>
  <span class="n">code_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  dw %s&quot;</span> <span class="o">%</span> <span class="n">printed</span><span class="p">)</span>

<span class="n">scramble_counter</span> <span class="o">=</span> <span class="mh">0x2743</span>

<span class="n">def</span> <span class="n">next_scramble_counter</span><span class="p">()</span><span class="o">:</span>
  <span class="n">global</span> <span class="n">scramble_counter</span>
  <span class="n">scramble_counter</span> <span class="o">=</span> <span class="n">scramble_counter</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">7</span>
  <span class="k">return</span> <span class="n">scramble_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>

<span class="n">def</span> <span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">:</span>
  <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">:</span>
    <span class="k">if</span> <span class="nl">scramble:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">next_scramble_counter</span><span class="p">()</span>
    <span class="k">else</span><span class="o">:</span>
      <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">printed</span> <span class="o">=</span> <span class="n">value</span>
  <span class="k">if</span> <span class="n">type</span><span class="p">(</span><span class="n">value</span><span class="p">).</span><span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="kt">int</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">printed</span> <span class="o">=</span> <span class="s">&quot;%d&quot;</span> <span class="o">%</span> <span class="n">value</span>
  <span class="n">data_segment</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  dw %s&quot;</span> <span class="o">%</span> <span class="n">printed</span><span class="p">)</span>

<span class="n">def</span> <span class="n">buffer</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span><span class="o">:</span>
    <span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="n">def</span> <span class="n">var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span>
  <span class="n">data_label</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">word</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

<span class="cp"># Macros</span>

<span class="n">def</span> <span class="n">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">NOR</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39; &#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39; &#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
  <span class="n">code</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

<span class="n">def</span> <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

<span class="n">def</span> <span class="n">OR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">NOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;or_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;or_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;or_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;and_reg_b&quot;</span><span class="p">)</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;and_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_reg_b&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ANDi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;and_i_reg&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;and_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;and_i_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;xor_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;xor_reg_b&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_reg_b&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">XORi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;xor_i_reg&quot;</span><span class="p">)</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;xor_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_i_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">MOV</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39; &#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;move_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">MOV</span> <span class="n">END</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">JMP</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">JMP</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">JMPi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">JMPi</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">JMP</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="n">def</span> <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">MOVi</span> <span class="err">#&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39; &#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
  <span class="n">label_data</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">label_jump</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">label_data</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">JMPi</span><span class="p">(</span><span class="n">label_jump</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label_data</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label_jump</span><span class="p">)</span>

<span class="cp"># [a] -&gt; b</span>
<span class="n">def</span> <span class="n">PEEK</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">label1</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">label2</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label2</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label1</span><span class="p">)</span>  <span class="err">#</span> <span class="n">NOT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">move_reg</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="err">#</span> <span class="o">&lt;-</span> <span class="n">a</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label2</span><span class="p">)</span>  <span class="err">#</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="err">#</span> <span class="o">&lt;-</span> <span class="n">a</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="err">#</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="cp"># a -&gt; [b]</span>
<span class="n">def</span> <span class="n">POKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">code_rem</span><span class="p">(</span><span class="err">&#39;</span><span class="n">POKE</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="err">&#39;</span> <span class="p">[</span><span class="err">&#39;</span> <span class="o">+</span> <span class="n">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;move_reg&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="o">+</span><span class="mi">3</span> <span class="p">(</span><span class="n">three</span> <span class="n">operations</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="err">#</span> <span class="o">+</span><span class="mi">4</span>
  <span class="n">code</span><span class="p">(</span><span class="s">&quot;move_reg&quot;</span><span class="p">)</span>    <span class="err">#</span> <span class="o">+</span><span class="mi">5</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">code</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>             <span class="err">#</span> <span class="o">&lt;-</span> <span class="n">b</span>

<span class="cp"># imm -&gt; [a]</span>
<span class="n">def</span> <span class="n">POKEi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;poke_i_reg&quot;</span><span class="p">)</span>
  <span class="n">POKE</span><span class="p">(</span><span class="s">&quot;poke_i_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;poke_i_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">EXIT</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">EXITi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">FADD</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_a&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="n">zero</span> <span class="n">bits</span> <span class="n">in</span> <span class="sc">&#39;a&#39;</span> <span class="n">except</span> <span class="n">mask</span><span class="err">&#39;</span><span class="n">ed</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_b&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="n">zero</span> <span class="n">bits</span> <span class="n">in</span> <span class="sc">&#39;b&#39;</span> <span class="n">except</span> <span class="n">mask</span><span class="err">&#39;</span><span class="n">ed</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>     <span class="err">#</span> <span class="n">zero</span> <span class="n">bits</span> <span class="n">in</span> <span class="err">&#39;</span><span class="n">carry</span><span class="err">&#39;</span> <span class="n">except</span> <span class="n">mask</span><span class="err">&#39;</span><span class="n">ed</span>

  <span class="cp"># SUM = (a ^ b) ^ carry</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>
  <span class="n">XOR</span><span class="p">(</span><span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">,</span> <span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>

  <span class="cp"># Leave only &#39;mask&#39;ed bit in bit_r.</span>
  <span class="n">AND</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>

  <span class="cp"># Add current added bit to the result.</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

  <span class="cp"># CARRY = (a &amp; b) | (carry &amp; (a ^ b))</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">)</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>

  <span class="cp"># CARRY is calculated, and &#39;shift_reg&#39; contains the same value</span>
  <span class="cp"># but shifted the left by 1 bit.</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">,</span> <span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

  <span class="cp"># CARRY is shifted the left by 1 bit to be used on the next round.</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

  <span class="cp"># shift_reg = mask &lt;&lt; 1</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
  <span class="cp"># mask = shift (effectively &quot;mask = mask &lt;&lt; 1&quot;)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>

  <span class="n">AND</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">carry</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_b&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_bit_r&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_t1&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadd_reg_t2&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ZERO</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">XOR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="n">def</span> <span class="n">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">:</span>
    <span class="n">FADD</span><span class="p">(</span><span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span><span class="o">:</span>
    <span class="n">OR</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>
    <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
    <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>

  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">,</span> <span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadc_reg_mask&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;fadc_reg_t&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
  <span class="n">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ADDi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">imm</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;add_i_reg&quot;</span><span class="p">)</span>
  <span class="n">ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;add_i_reg&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;add_i_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">PUSH</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ADD</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>
  <span class="n">POKE</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">PUSHi</span><span class="p">(</span><span class="n">imm</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">imm</span><span class="p">,</span> <span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>
  <span class="n">PUSH</span><span class="p">(</span><span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;push_i_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">POP</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
  <span class="n">ADD</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;stack_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">CALL</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">PUSHi</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">JMP</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="n">def</span> <span class="n">CALLi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">PUSHi</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
  <span class="n">JMPi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="n">def</span> <span class="n">RET</span><span class="p">()</span><span class="o">:</span>
  <span class="n">POP</span><span class="p">(</span><span class="s">&quot;ip&quot;</span><span class="p">)</span>

<span class="cp"># Jump &#39;a&#39;, if cond = FFFF, and &#39;b&#39; if conf = 0000</span>
<span class="n">def</span> <span class="n">BRANCH</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span><span class="o">:</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span> <span class="s">&quot;branch_reg_a&quot;</span><span class="p">)</span>              <span class="err">#</span> <span class="n">reg_a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">cond</span>
  <span class="n">NOT</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>                 <span class="err">#</span> <span class="n">reg_b</span> <span class="o">=</span> <span class="o">!</span><span class="n">cond</span>
  <span class="n">AND</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>    <span class="err">#</span> <span class="n">reg_b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="n">reg_b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="o">!</span><span class="n">cond</span>
  <span class="n">OR</span><span class="p">(</span><span class="s">&quot;branch_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;branch_reg_b&quot;</span><span class="p">,</span> <span class="s">&quot;ip&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="n">ip</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">cond</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="o">!</span><span class="n">cond</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_reg_b&quot;</span><span class="p">)</span>

<span class="cp"># Jump &#39;a&#39;, if cond = FFFF, and &#39;b&#39; if conf = 0000</span>
<span class="n">def</span> <span class="n">BRANCHi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">)</span>
  <span class="n">MOVi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">)</span>
  <span class="n">BRANCH</span><span class="p">(</span><span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">,</span> <span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_i_reg_a&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;branch_i_reg_b&quot;</span><span class="p">)</span>

<span class="cp"># if a != 0 -&gt; carry = FFFF else carry = 0000</span>
<span class="n">def</span> <span class="n">IS_0</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ZERO</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
  <span class="n">FADC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;is_0_reg&quot;</span><span class="p">)</span>
  <span class="n">NOT</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;is_0_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>

<span class="cp"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="n">def</span> <span class="n">JZi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">BRANCHi</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="cp"># ip = (zero_reg == FFFF ? a : ip)</span>
<span class="n">def</span> <span class="n">JNZi</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">:</span>
  <span class="n">label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
  <span class="n">BRANCHi</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s">&quot;zero_reg&quot;</span><span class="p">)</span>
  <span class="n">code_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ROL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>            <span class="err">#</span> <span class="n">shift_reg</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">def</span> <span class="n">ROR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">MOV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span><span class="o">:</span>
    <span class="n">ROL</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">,</span> <span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>
  <span class="n">MOV</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;ror_reg&quot;</span><span class="p">)</span>

<span class="n">def</span> <span class="n">SHL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ROL</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">ANDi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">def</span> <span class="n">SHR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ROR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
  <span class="n">ANDi</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

<span class="n">def</span> <span class="n">MUL3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">ADD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s">&quot;mul3_reg&quot;</span><span class="p">)</span>    <span class="err">#</span> <span class="n">mul3_reg</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span>
  <span class="n">ADD</span><span class="p">(</span><span class="s">&quot;mul3_reg&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>    <span class="err">#</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mul3_reg</span> <span class="o">+</span> <span class="n">a</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;mul3_reg&quot;</span><span class="p">)</span>

<span class="cp"># NORCPU code</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ip&quot;</span><span class="p">,</span> <span class="s">&quot;start&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;shift_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;carry_reg&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;exit_reg&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;stack_reg&quot;</span><span class="p">,</span> <span class="s">&quot;stack&quot;</span><span class="p">)</span>

<span class="n">code_label</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;t&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;cmp_flag&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">)</span>
<span class="n">var</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;exchange&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;secret_password&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>
<span class="n">MOVi</span><span class="p">(</span><span class="n">secret_password_xor_mask</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>
<span class="n">MOVi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;cmp_flag&quot;</span><span class="p">)</span>
<span class="n">MOVi</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">secret_password</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>

<span class="n">cmp_loop</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">cmp_loop</span><span class="p">)</span>               <span class="err">#</span> <span class="nl">cmp_loop:</span>
<span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>                                      <span class="err">#</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>                            <span class="err">#</span> <span class="n">ch</span> <span class="o">^=</span> <span class="n">xor_mask</span>
<span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">)</span>                                      <span class="err">#</span> <span class="n">t</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr2</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>                                   <span class="err">#</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">^</span> <span class="n">t</span>
<span class="n">OR</span><span class="p">(</span><span class="s">&quot;cmp_flag&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;cmp_flag&quot;</span><span class="p">)</span>                       <span class="err">#</span> <span class="n">cmp_flag</span> <span class="o">|=</span> <span class="n">ch</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>                           <span class="err">#</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>                         <span class="err">#</span> <span class="n">ptr2</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">MUL3</span><span class="p">(</span><span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>                           <span class="err">#</span> <span class="n">xor_mask</span> <span class="o">*=</span> <span class="mi">3</span>
<span class="n">ADDi</span><span class="p">(</span><span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="n">secret_password_add</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>      <span class="err">#</span> <span class="n">xor_mask</span> <span class="o">+=</span> <span class="n">add_const</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>                         <span class="err">#</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">cmp_loop</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;exchange_sz&quot;</span><span class="p">)</span>

<span class="n">ok_label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;cmp_flag&quot;</span><span class="p">)</span>
<span class="n">JZi</span><span class="p">(</span><span class="n">ok_label</span><span class="p">)</span>

<span class="n">exit_label</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">JMPi</span><span class="p">(</span><span class="n">exit_label</span><span class="p">)</span>

<span class="n">code_label</span><span class="p">(</span><span class="n">ok_label</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;secret_code&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>
<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;secret_code_sz&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">MOVi</span><span class="p">(</span><span class="n">secret_code_xor_mask</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>

<span class="n">MOVi</span><span class="p">(</span><span class="s">&quot;exchange&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>

<span class="n">MOV</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;exchange_sz&quot;</span><span class="p">)</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">next_label</span><span class="p">()</span>
<span class="n">code_label</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>                   <span class="err">#</span> <span class="nl">loop:</span>
<span class="n">PEEK</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>                             <span class="err">#</span> <span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span>
<span class="n">XOR</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="s">&quot;ch&quot;</span><span class="p">)</span>                   <span class="err">#</span> <span class="n">ch</span> <span class="o">^=</span> <span class="n">xor_mask</span>
<span class="n">POKE</span><span class="p">(</span><span class="s">&quot;ch&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>                            <span class="err">#</span> <span class="o">*</span><span class="n">ptr2</span> <span class="o">=</span> <span class="n">ch</span>
<span class="n">MUL3</span><span class="p">(</span><span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span>                  <span class="err">#</span> <span class="n">xor_mask</span> <span class="o">*=</span> <span class="mi">3</span>
<span class="n">ADDi</span><span class="p">(</span><span class="s">&quot;xor_mask&quot;</span><span class="p">,</span> <span class="n">secret_code_add</span><span class="p">,</span> <span class="s">&quot;xor_mask&quot;</span><span class="p">)</span> <span class="err">#</span> <span class="n">xor_mask</span> <span class="o">+=</span> <span class="n">add_const</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr&quot;</span><span class="p">)</span>                  <span class="err">#</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;ptr2&quot;</span><span class="p">,</span> <span class="s">&quot;const_1&quot;</span><span class="p">,</span> <span class="s">&quot;ptr2&quot;</span><span class="p">)</span>                <span class="err">#</span> <span class="n">ptr2</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">ADD</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;const_minus_1&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">)</span>                <span class="err">#</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">IS_0</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">)</span>
<span class="n">JNZi</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

<span class="n">code_label</span><span class="p">(</span><span class="n">exit_label</span><span class="p">)</span>             <span class="err">#</span> <span class="nl">exit_label:</span>
<span class="n">EXITi</span><span class="p">(</span><span class="mh">0x00</span><span class="p">)</span>

<span class="n">buffer</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;stack&quot;</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;secret_code_sz&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">secret_code</span><span class="p">))</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;secret_code&quot;</span><span class="p">)</span>
<span class="n">buffer</span><span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">secret_code</span><span class="p">))</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;secret_password_sz&quot;</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;secret_password&quot;</span><span class="p">)</span>
<span class="n">buffer</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

<span class="n">var</span><span class="p">(</span><span class="s">&quot;exchange_sz&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">data_label</span><span class="p">(</span><span class="s">&quot;exchange&quot;</span><span class="p">)</span>
<span class="n">buffer</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>

<span class="cp"># Compiler</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">code_segment</span>
<span class="n">text</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data_segment</span><span class="p">)</span>

<span class="k">if</span> <span class="nl">verbose:</span>
  <span class="n">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="cp"># Phase 1. Calculate names.</span>

<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">names</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line</span> <span class="n">in</span> <span class="nl">text:</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="o">:</span> <span class="k">continue</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">partition</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span>
  <span class="k">else</span><span class="o">:</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">if</span> <span class="nl">verbose:</span>
  <span class="n">print</span> <span class="n">names</span>

<span class="n">raw_text</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="cp"># Resolve names.</span>

<span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="nl">names:</span>
  <span class="k">if</span> <span class="nl">verbose:</span>
    <span class="n">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">type</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
  <span class="n">name_re</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="n">dw</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="p">.</span><span class="n">M</span><span class="p">)</span>
  <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;%d&quot;</span> <span class="o">%</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
  <span class="n">raw_text</span> <span class="o">=</span> <span class="n">name_re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="err">&#39;</span><span class="n">dw</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">)</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">raw_text</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nl">verbose:</span>
  <span class="n">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="cp"># Phase 2. Compilation.</span>

<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="n">mem</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="n">in</span> <span class="nl">text:</span>
  <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span> <span class="n">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="o">:</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="sc">&#39; &#39;</span>
  <span class="k">else</span><span class="o">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">partition</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="nl">verbose:</span>
      <span class="n">print</span> <span class="s">&quot;%04X: %04X ; %s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="n">mem</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

<span class="cp"># Interpretation</span>

<span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">]</span>
<span class="n">exit_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exit_reg&quot;</span><span class="p">]</span>
<span class="n">shift_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;shift_reg&quot;</span><span class="p">]</span>
<span class="n">carry_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;carry_reg&quot;</span><span class="p">]</span>

<span class="n">def</span> <span class="n">nor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|</span> <span class="n">b</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">r</span> <span class="o">^</span> <span class="mh">0xFFFF</span>
  <span class="k">return</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>

<span class="n">def</span> <span class="n">norcpu</span><span class="p">()</span><span class="o">:</span>
  <span class="k">while</span> <span class="mi">1</span><span class="o">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">];</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">nor</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">mem</span><span class="p">[</span><span class="n">b</span><span class="p">])</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">mem</span><span class="p">[</span><span class="n">shift_reg</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nl">verbose_cpu:</span>
      <span class="n">print</span> <span class="s">&quot;%04X: %04X [%04X] %04X [%04X] -&gt; %04X [%04X]&quot;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">b</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="nl">exit_reg:</span>
      <span class="k">break</span>

<span class="n">print</span> <span class="s">&quot;Starting from [%04X]&quot;</span> <span class="o">%</span> <span class="n">mem</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>

<span class="n">encode_string</span><span class="p">(</span><span class="n">secret_code</span><span class="p">,</span> <span class="s">&quot;secret_code&quot;</span><span class="p">,</span> <span class="n">secret_code_xor_mask</span><span class="p">,</span> <span class="n">secret_code_add</span><span class="p">);</span>
<span class="n">encode_string</span><span class="p">(</span><span class="n">secret_password</span><span class="p">,</span> <span class="s">&quot;secret_password&quot;</span><span class="p">,</span> <span class="n">secret_password_xor_mask</span><span class="p">,</span> <span class="n">secret_password_add</span><span class="p">);</span>

<span class="n">mem_js</span> <span class="o">=</span> <span class="n">dump_js</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-1-before.bin&quot;</span><span class="p">)</span>
<span class="n">mem_sz</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x10000</span><span class="o">:</span>
  <span class="n">print</span> <span class="s">&quot;Too much code (%08X, %04X)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10000</span><span class="p">)</span>
  <span class="n">sys</span><span class="p">.</span><span class="n">exit</span><span class="p">()</span>

<span class="cp"># Inject plain password in the last moment (for testing).</span>
<span class="n">put_string</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="s">&quot;exchange&quot;</span><span class="p">)</span>

<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-2-before-with-password.bin&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nl">verbose:</span>
  <span class="n">print</span> <span class="s">&quot;Original memory:&quot;</span>
  <span class="n">print</span> <span class="n">dump</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">norcpu</span><span class="p">()</span>

<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">save_mem</span><span class="p">(</span><span class="s">&quot;norcpu-3-after.bin&quot;</span><span class="p">,</span> <span class="n">mem_sz</span><span class="p">)</span>

<span class="k">if</span> <span class="nl">verbose:</span>
  <span class="n">print</span> <span class="s">&quot;Memory after:&quot;</span>
  <span class="n">dump</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>

<span class="n">print</span>
<span class="n">print</span> <span class="s">&quot;Size: %X&quot;</span> <span class="o">%</span> <span class="n">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
<span class="n">print</span> <span class="s">&quot;Time: %d&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
<span class="n">print</span> <span class="s">&quot;Exit: %04X&quot;</span> <span class="o">%</span> <span class="n">mem</span><span class="p">[</span><span class="n">exit_reg</span><span class="p">]</span>

<span class="n">exchange</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exchange&quot;</span><span class="p">]</span>
<span class="n">result_value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="s">&quot;exchange_sz&quot;</span><span class="p">]])</span><span class="o">:</span>
  <span class="n">result_value</span> <span class="o">=</span> <span class="n">result_value</span> <span class="o">+</span> <span class="n">chr</span><span class="p">(</span><span class="n">mem</span><span class="p">[</span><span class="n">exchange</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>

<span class="n">print</span> <span class="s">&quot;Result: [%s]&quot;</span> <span class="o">%</span> <span class="n">result_value</span>

<span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">result_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">:</span>
  <span class="n">print</span> <span class="s">&quot;ERROR: Wrong password&quot;</span>

<span class="n">js</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">Template</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="k">template</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">).</span><span class="n">read</span><span class="p">())</span>

<span class="n">js</span> <span class="o">=</span> <span class="n">js</span><span class="p">.</span><span class="n">substitute</span><span class="p">(</span> \
  <span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">],</span>
  <span class="n">exit_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exit_reg&quot;</span><span class="p">],</span>
  <span class="n">shift_reg</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;shift_reg&quot;</span><span class="p">],</span>
  <span class="n">exchange</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exchange&quot;</span><span class="p">],</span>
  <span class="n">exchange_sz</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="s">&quot;exchange_sz&quot;</span><span class="p">],</span>
  <span class="n">mem_js</span> <span class="o">=</span> <span class="n">mem_js</span>
<span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;norcpu2.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">js</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

</div>

<hr />


  <a href="http://meta-coding.blogspot.com/2011/02/one-command-norcpu-program-hacking.html"><small>Original post</small></a>


<h1>Comments</h1>

<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqus_shortname = 'meta-coding';
  var disqus_developer = 0;
  var disqus_identifier = 'http://meta-coding.blogspot.com/2011/02/one-command-norcpu-program-hacking.html';
  var disqus_url = 'http://meta-coding.blogspot.com/2011/02/one-command-norcpu-program-hacking.html';
  var disqus_script = 'embed.js';
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


  </div>

  <div class="footer">
    <div class="contact">
      &copy; 2012
      <a href="mailto:alexander@demin.ws">Alexander Demin</a> |
      <a href="/english/atom.xml" rel="subscribe-rss" title="Subscribe via RSS">RSS</a>
    </div>
  </div>

</div>

</body>
</html>
