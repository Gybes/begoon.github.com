<!DOCTYPE html>
 
<html>
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Тонкости использования getenv() и putenv()</title>
   <link href="/favicon.png" rel="icon" />
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3017739-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
   <link rel="stylesheet" type="text/css" href="/css/highlight.css" />
   <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" />
   <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" /> 
   <link rel="alternate" title="Программирования - это просто!" href="/atom.xml" type="application/atom+xml">
</head>
<body>

<div class="site">

  <div class="menu">
    <a class="extra" href="/english">&laquo; english &raquo;</a>  
    <a href="/">блог</a> |
    <a href="/projects/">проекты</a> |
    <a href="/articles/">статьи</a> |
    <a href="/about/">автор</a>
  </div>

  <div id="home">
    <h1>Тонкости использования getenv() и putenv()</h1>
<div id="post">
  <p>Нарвался тут на интересные грабли с функциями <a href="http://www.kernel.org/doc/man-pages/online/pages/man3/getenv.3.html">getenv()</a> и <a href="http://www.kernel.org/doc/man-pages/online/pages/man3/putenv.3.html">putenv()</a>.</p>

<p>С <code>putenv()</code> у меня <a href="/blog/russian/2009/02/01/static-argument-of-putenv/">уже был интересный опыт</a>.</p>

<p>Часто люди пишут так:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;A_FLAG&quot;</span><span class="p">))</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>Это работает неплохо для переменных-флагов, которые либо есть, либо нет. Значение не важно.</p>

<p>Что получилось у меня:</p>

<div class="highlight"><pre><span class="kt">int</span> <span class="n">main</span><span class="p">(...)</span> <span class="p">{</span>
  <span class="n">putenv</span><span class="p">(</span><span class="s">&quot;GLOBAL_FLAG=1&quot;</span><span class="p">);</span>  <span class="c1">// Глобальное значение для всей программы.</span>
  <span class="p">...</span>
  <span class="n">system</span><span class="p">(</span><span class="s">&quot;xyz&quot;</span><span class="p">);</span>            <span class="c1">// Это программа должна видеть GLOBAL_FLAG=1.</span>
  <span class="p">...</span>
  <span class="n">do_stuff</span><span class="p">();</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">do_stuff</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">something</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">putenv</span><span class="p">(</span><span class="s">&quot;GLOBAL_FLAG=&quot;</span><span class="p">);</span> <span class="c1">// Убрать переменную.</span>
    <span class="n">system</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">);</span>          <span class="c1">// А вот для этой программы флаг должен быть убран.</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;GLOBAL_FLAG&quot;</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// И вот тут начиналась ерунда на разных платформах.</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>А корень зла тут в том, что после <code>putenv()</code> результат <code>getenv()</code> может стать либо <code>NULL</code>, либо <code>&quot;&quot;</code>, в зависимости от платформы.</p>

<p>Например:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;GLOBAL_FLAG&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
</pre></div>

<p>работает только на Windows и правильнее писать:</p>

<div class="highlight"><pre><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;GLOBAL_FLAG&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>И лучше сделать wrapper для <code>getenv()</code>:</p>

<div class="highlight"><pre><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">GetEnv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">v</span> <span class="o">?</span> <span class="n">v</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>И для проверки писать:</p>

<div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetEnv</span><span class="p">(</span><span class="s">&quot;var&quot;</span><span class="p">).</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">..</span>
<span class="p">}</span>
</pre></div>

<p>Для теста я написал программу, которая выставляет переменную и проверяет ее значение через <code>getenv()</code> и через вызов дочерней программы.</p>

<div class="highlight"><pre><span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;vector&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;cstdlib&gt;</span>

<span class="cp">#ifdef WINDOWS</span>
<span class="cp">#define putenv _putenv</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">PrintVariableViaShell</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Value from shell:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">cmd</span> <span class="o">=</span>
<span class="cp">#ifdef WINDOWS</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;cmd /c echo [%&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;%]&quot;</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">&quot;/bin/sh -c </span><span class="se">\&quot;</span><span class="s">echo [$&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;]</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">PrintVariableViaGetEnv</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Value from getenv():&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[&quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">v</span> <span class="o">?</span> <span class="n">v</span> <span class="o">:</span> <span class="s">&quot;&lt;NULL&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SetVariableDeleteAndPrint</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name_value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">equ</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name_value_s</span><span class="p">(</span><span class="n">name_value</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name_value_s</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name_value_s</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">));</span>

  <span class="n">putenv</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">name_value</span><span class="p">));</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">delete_without_equ</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="n">delete_without_equ</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">);</span>
  <span class="n">putenv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delete_without_equ</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Value after deleting WITHOUT &#39;=&#39;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">PrintVariableViaShell</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">PrintVariableViaGetEnv</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="n">putenv</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">name_value</span><span class="p">));</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">delete_with_equ</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">name</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="n">delete_with_equ</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;=&#39;</span><span class="p">);</span>
  <span class="n">delete_with_equ</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">);</span>
  <span class="n">putenv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delete_with_equ</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Value after deleting WITH &#39;=&#39;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">PrintVariableViaShell</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="n">PrintVariableViaGetEnv</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="cp">#ifdef WINDOWS</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;WINDOWS&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="n">system</span><span class="p">(</span><span class="s">&quot;uname&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">SetVariableDeleteAndPrint</span><span class="p">(</span><span class="s">&quot;ABC=123&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>

<p>И вот результы с разных платформ.</p>

<p><strong>Linux</strong></p>

<pre><code>Linux
Value after deleting WITHOUT '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[]
Value from getenv():
[&lt;NULL&gt;]

Value after deleting WITH '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[]
Value from getenv():
[]
</code></pre>

<p><strong>AIX</strong></p>

<pre><code>AIX
Value after deleting WITHOUT '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[123]
Value from getenv():
[123]

Value after deleting WITH '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[]
Value from getenv():
[]
</code></pre>

<p><strong>SunOS</strong></p>

<pre><code>SunOS
Value after deleting WITHOUT '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[123]
Value from getenv():
[123]

Value after deleting WITH '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[]
Value from getenv():
[]
</code></pre>

<p><strong>HP-UX</strong></p>

<pre><code>HP-UX
Value after deleting WITHOUT '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[123]
Value from getenv():
[123]

Value after deleting WITH '=':
Value from shell:
/bin/sh -c &quot;echo [$ABC]&quot;
[]
Value from getenv():
[]
</code></pre>

<p><strong>WINDOWS</strong></p>

<pre><code>WINDOWS
Value after deleting WITHOUT '=':
Value from shell:
cmd /c echo [%ABC%]
[123]
Value from getenv():
[123]

Value after deleting WITH '=':
Value from shell:
cmd /c echo [%ABC%]
[%ABC%]
Value from getenv():
[&lt;NULL&gt;]
</code></pre>

<p>Только на Windows <code>getenv()</code> возвращает <code>NULL</code> после удаления. На остальных это будет пустая строка.</p>

<p>Забавно, на Linux можно удалять переменные через <code>putenv(&quot;name&quot;)</code> (без знака &ldquo;=&rdquo;), а тогда <code>getenv()</code> будет возвращать <code>NULL</code>.</p>

<p>Посты по теме:</p>

<ul>
<li><a href="/blog/russian/2009/02/01/static-argument-of-putenv/">Статический аргумент функции putenv</a></li>
</ul>

</div>

<hr />


  <a href="http://easy-coding.blogspot.com/2011/11/getenv-putenv.html"><small>Оригинальный пост</small></a>


<h1>Комментарии</h1>

<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqus_shortname = 'easy-coding';
  var disqus_developer = 0;
  var disqus_identifier = 'http://easy-coding.blogspot.com/2011/11/getenv-putenv.html';
  var disqus_url = 'http://easy-coding.blogspot.com/2011/11/getenv-putenv.html';
  var disqus_script = 'embed.js';
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


  </div>

  <div class="footer">
    <div class="contact">
      &copy; 2012
      <a href="mailto:alexander@demin.ws">Александр Дëмин</a> |
      <a href="/atom.xml" rel="subscribe-rss" title="Подписаться через RSS">RSS</a>
    </div>
  </div>

</div>

</body>
</html>
