<!DOCTYPE html>
 
<html>
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Решето Эратосфена - кто быстрее: Go, C или C++?</title>
   <link href="/favicon.png" rel="icon" />
   <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3017739-19']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
   <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" />
   <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" /> 
   <link rel="alternate" title="Программирования - это просто!" href="/atom.xml" type="application/atom+xml">
</head>
<body>

<div class="site">

  <div class="menu">
    <a class="extra" href="/english">&laquo; english &raquo;</a>  
    <a href="/">блог</a> |
    <a href="/projects/">проекты</a> |
    <a href="/articles/">статьи</a> |
    <a href="/about/">автор</a>
  </div>

  <div id="home">
    <h1>Решето Эратосфена - кто быстрее: Go, C или C++?</h1>
<div id="post">
  <p><a href="http://golang.org/">Go</a> очень интересный язык. Компиляция в native-code (никаких виртуальных машин, JIT-компиляций и т.д.), при этом автоматическая сборка мусора и встроенная поддержка многопоточности, объектно-ориентированная модель, и в довершение всего - очень быстрая компиляция.</p>

<p>Лично я обычно на новых для меня языках люблю писать <a href="http://ru.wikipedia.org/wiki/%D0%A0%D0%B5%D1%88%D0%B5%D1%82%D0%BE_%D0%AD%D1%80%D0%B0%D1%82%D0%BE%D1%81%D1%84%D0%B5%D0%BD%D0%B0">Решето Эратосфена</a> в качестве &ldquo;Hello, world!&rdquo;.</p>

<p>Моя версия на Go.</p>

<p>Файл <code>erato-go-bool.go</code>:</p>

<pre><code class="go">package main

import &quot;fmt&quot;
import &quot;math&quot;
import &quot;flag&quot;

func main() {
    var N int
    flag.IntVar(&amp;N, &quot;N&quot;, 100, &quot;&quot;)
    flag.Parse()

    fmt.Printf(&quot;%d\n&quot;, N)

    seive := make([]bool, N)
   
    limit := int(math.Sqrt(float64(N))) + 1

    for i := 2; i &lt; limit; i++ {
        if !seive[i] {
            for j := i * i; j &lt; N; j += i  {
                seive[j] = true
            }
        }
    }

    count := 0
    for i := 2; i &lt; N; i++ {
        if !seive[i] {
            count++
        }
    }
    fmt.Printf(&quot;%d\n&quot;, count)
}
</code></pre>

<p>И первый вопрос, который приходит в голову - а насколько это быстро работает?</p>

<p>Некоторое время назад я уже <a href="/blog/russian/2009/02/01/what-is-faster-vector-int-or-bool/">писал</a>, как использовал решето для тестирования STL&rsquo;евского контейнера <code>std::vector</code> на разных компиляторах.</p>

<p>Сейчас я провел похожее сравнение между Go, C++ и C.</p>

<p>Итак, первый кандитат - версия на Go с использованием типа <code>bool</code> (см. выше). Второй - тоже на Go, но с использованием типа <code>int</code>.</p>

<p>Файл <code>erato-go-int.go</code>:</p>

<pre><code class="go">package main

import &quot;fmt&quot;
import &quot;math&quot;
import &quot;flag&quot;

func main() {
    var N int
    flag.IntVar(&amp;N, &quot;N&quot;, 100, &quot;&quot;)
    flag.Parse()

    fmt.Printf(&quot;%d\n&quot;, N)

    seive := make([]int, N)
   
    limit := int(math.Sqrt(float64(N))) + 1

    for i := 2; i &lt; limit; i++ {
        if seive[i] == 0 {
            for j := i * i; j &lt; N; j += i  {
                seive[j] = 1
            }
        }
    }

    count := 0
    for i := 2; i &lt; N; i++ {
        if seive[i] == 0 {
            count++
        }
    }
    fmt.Printf(&quot;%d\n&quot;, count)
}
</code></pre>

<p>Файл <code>erato-cxx.cpp</code>:</p>

<pre><code class="cpp">#include &lt;iostream&gt;
#include &lt;vector&gt;
#include &lt;cstdlib&gt;
#include &lt;cmath&gt;

int main(int argc, char* argv[]) {
  int n = argc &gt; 1 ? std::atoi(argv[1]) : 100;

  std::cout &lt;&lt; n &lt;&lt; std::endl;

  int sqrt_n = static_cast&lt;int&gt;(std::sqrt(static_cast&lt;double&gt;(n))) + 1;

  std::vector&lt;TYPE&gt; S(n, true);

  for (int i = 2; i &lt; sqrt_n; ++i)
    if (S[i])
      for (int j = i*i; j &lt; n; j+=i)
        S[j] = false;

  int count = 0;
  for (int i = 2; i &lt; n; ++i)
    if (S[i])
      count++;

  std::cout &lt;&lt; count &lt;&lt; std::endl;

  return 0;
}
</code></pre>

<p>Ну и для полноты картины версия на С:</p>

<p>Файл <code>erato-c-int.c</code>:</p>

<pre><code class="cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;memory.h&gt;
#include &lt;math.h&gt;

int main(int argc, char* argv[]) {
  int n = argc &gt; 1 ? atoi(argv[1]) : 100;
  int* S;
  int count;
  int sz = n * sizeof(*S);
  int i, j;

  printf(&quot;%d\n&quot;, n);

  long sqrt_n = sqrt(n) + 1;

  S = malloc(sz);
  memset(S, 0, sz);

  for (i = 2; i &lt; sqrt_n; ++i)
    if (S[i] == 0)
      for (j = i*i; j &lt; n; j+=i)
        S[j] = 1;

  count = 0;
  for (i = 2; i &lt; n; ++i)
    if (S[i] == 0)
      count++;

  printf(&quot;%d\n&quot;, count);

  free(S);
  return 0;
}
</code></pre>

<p>Ну и <code>Makefile</code> для удобного запуска:</p>

<pre><code class="makefile">.SILENT: 

all: 
        $(MAKE) run 2&gt;&amp;1 | tee log
        $(MAKE) parse-log

run: go-bool go-int cxx-int cxx-bool c-int

N ?= 100000000

go-bool:
        echo $@
        6g erato-$@.go
        6l -o erato-$@ erato-$@.6
        time -p -f %e ./erato-$@ -N=$(N)

go-int: 
        echo $@
        6g erato-$@.go
        6l -o erato-$@ erato-$@.6
        time -p -f %e ./erato-$@ -N=$(N)

cxx-bool:
        echo $@
        g++ -o erato-$@ \
                -O3 -funroll-all-loops -fomit-frame-pointer \
                -DTYPE=bool erato-cxx.cpp 
        time -p -f %e ./erato-$@ $(N)

cxx-int:
        echo $@
        g++ -o erato-$@ \
                -O3 -funroll-all-loops -fomit-frame-pointer \
                -DTYPE=int erato-cxx.cpp 
        time -p -f %e ./erato-$@ $(N)

c-int:
        echo $@
        gcc -o erato-$@ -lm \
                 -O3 -funroll-all-loops -fomit-frame-pointer erato-$@.c
        time -p -f %e ./erato-$@ $(N)

parse-log:
        printf &quot;%10s %10s %8s %5s\n&quot; &quot;Language&quot; N Count Time ; \
        (echo &quot;------------------------------------&quot;) ; \
        while read type ; do \
                read N &amp;&amp; \
                read count &amp;&amp; \
                read time &amp;&amp; \
                printf &quot;%10s %10s %8s %5s\n&quot; $$type $$N $$count $$time ; \
        done &lt; log
</code></pre>

<p>Запускал я все это под Ubuntu 64-bit. Компилятор C и C++ - gcc 4.4.1. Компилятор Go - последний из <a href="http://golang.org/doc/install.html">официального репозитория</a>.</p>

<p>Запускаем:</p>

<pre><code>make N=100000000
</code></pre>

<p>и получаем следующее:</p>

<pre><code> Language           N    Count  Time
------------------------------------
   go-bool  100000000  5761455  3.96
    go-int  100000000  5761455  6.58
   cxx-int  100000000  5761455  6.76
  cxx-bool  100000000  5761455  2.20
     c-int  100000000  5761455  6.47
</code></pre>

<p>Получается, что сделал всех С++ с использованием <code>std::vector&lt;bool&gt;</code> для хранения массива. Затем идет Go тоже с типом <code>bool</code>. А С, С++ с <code>std::vector&lt;int&gt;</code> и Go с <code>int</code>&lsquo;ом примерно равны.</p>

<p><strong>Update</strong>: После экспериментов в комментариях выходит, что и на С, и на С++ можно добиться равного быстродействия, если использовать битовые поля. Просто в С++ это синтаксически проще, но не более того.</p>

<p>Посты по теме:</p>

<ul>
<li><a href="/blog/russian/2009/02/01/what-is-faster-vector-int-or-bool/">Кто быстрее: vector&lt;bool&gt; или vector&lt;int&gt;</a></li>
</ul>

</div>

<hr />


  <a href="http://easy-coding.blogspot.com/2010/03/go-c-c.html"><small>Оригинальный пост</small></a>


<h1>Комментарии</h1>

<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqus_shortname = 'easy-coding';
  var disqus_developer = 0;
  var disqus_identifier = 'http://easy-coding.blogspot.com/2010/03/go-c-c.html';
  var disqus_url = 'http://easy-coding.blogspot.com/2010/03/go-c-c.html';
  var disqus_script = 'embed.js';
  (function () {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


  </div>

  <div class="footer">
    <div class="contact">
      &copy; 2012
      <a href="mailto:alexander@demin.ws">Александр Дëмин</a> |
      <a href="/atom.xml" rel="subscribe-rss" title="Подписаться через RSS">RSS</a>
    </div>
  </div>

</div>

</body>
</html>
